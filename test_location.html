<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Test - OrangeRoute</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; border-radius: 8px; }
        .status { margin: 10px 0; padding: 10px; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        #map { height: 300px; width: 100%; border: 1px solid #ccc; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
    </style>
</head>
<body>
    <h1>OrangeRoute Location Test</h1>
    
    <div class="test-section">
        <h3>1. Browser Geolocation Support</h3>
        <div id="geolocation-support" class="status info">Checking...</div>
    </div>
    
    <div class="test-section">
        <h3>2. Get Current Location</h3>
        <button id="get-location-btn" class="btn-primary">Get My Location</button>
        <div id="location-status" class="status info">Click the button to test location access</div>
        <div id="coordinates" class="status info" style="display: none;"></div>
    </div>
    
    <div class="test-section">
        <h3>3. Map Display</h3>
        <div id="map"></div>
    </div>
    
    <div class="test-section">
        <h3>4. API Test</h3>
        <button id="test-api-btn" class="btn-secondary" disabled>Test Location API</button>
        <div id="api-status" class="status info">Get location first to test API</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Test 1: Check geolocation support
        const geolocationSupport = document.getElementById('geolocation-support');
        if (navigator.geolocation) {
            geolocationSupport.innerHTML = '✅ Geolocation API is supported';
            geolocationSupport.className = 'status success';
        } else {
            geolocationSupport.innerHTML = '❌ Geolocation API is not supported';
            geolocationSupport.className = 'status error';
        }

        // Test 2: Get location
        const getLocationBtn = document.getElementById('get-location-btn');
        const locationStatus = document.getElementById('location-status');
        const coordinates = document.getElementById('coordinates');
        const testApiBtn = document.getElementById('test-api-btn');
        const apiStatus = document.getElementById('api-status');
        
        let currentLocation = null;
        let map = null;

        getLocationBtn.addEventListener('click', function() {
            locationStatus.innerHTML = 'Getting your location...';
            locationStatus.className = 'status info';
            getLocationBtn.disabled = true;
            
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    currentLocation = {
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    locationStatus.innerHTML = '✅ Location obtained successfully!';
                    locationStatus.className = 'status success';
                    
                    coordinates.innerHTML = `
                        <strong>Coordinates:</strong><br>
                        Latitude: ${currentLocation.latitude.toFixed(6)}<br>
                        Longitude: ${currentLocation.longitude.toFixed(6)}<br>
                        Accuracy: ${currentLocation.accuracy.toFixed(0)} meters
                    `;
                    coordinates.style.display = 'block';
                    
                    testApiBtn.disabled = false;
                    getLocationBtn.disabled = false;
                    
                    // Show on map
                    showLocationOnMap(currentLocation);
                },
                function(error) {
                    let errorMessage = 'Unable to get your location. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Please allow location access.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Location information is unavailable.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Location request timed out.';
                            break;
                    }
                    locationStatus.innerHTML = '❌ ' + errorMessage;
                    locationStatus.className = 'status error';
                    getLocationBtn.disabled = false;
                }
            );
        });

        // Test 3: Show on map
        function showLocationOnMap(location) {
            if (!map) {
                map = L.map('map').setView([location.latitude, location.longitude], 15);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors'
                }).addTo(map);
            } else {
                map.setView([location.latitude, location.longitude], 15);
            }
            
            // Clear existing markers
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            
            const marker = L.marker([location.latitude, location.longitude])
                .addTo(map)
                .bindPopup('Your current location')
                .openPopup();
        }

        // Test 4: API test
        testApiBtn.addEventListener('click', function() {
            if (!currentLocation) {
                apiStatus.innerHTML = '❌ No location data available';
                apiStatus.className = 'status error';
                return;
            }
            
            apiStatus.innerHTML = 'Testing API...';
            apiStatus.className = 'status info';
            testApiBtn.disabled = true;
            
            // Test with a dummy shuttle ID (you'll need to replace with actual shuttle ID)
            const testData = {
                shuttle_id: 1, // Replace with actual shuttle ID
                latitude: currentLocation.latitude,
                longitude: currentLocation.longitude
            };
            
            fetch('backend/update_location.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(testData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    apiStatus.innerHTML = '✅ API test successful: ' + data.message;
                    apiStatus.className = 'status success';
                } else {
                    apiStatus.innerHTML = '❌ API test failed: ' + data.message;
                    apiStatus.className = 'status error';
                }
                testApiBtn.disabled = false;
            })
            .catch(error => {
                apiStatus.innerHTML = '❌ API test error: ' + error.message;
                apiStatus.className = 'status error';
                testApiBtn.disabled = false;
            });
        });
    </script>
</body>
</html>
